---
output:
  word_document:
    reference_docx: templates/custom-reference.docx
bibliography: bib/references.bib
csl: csl/csas.csl
link-citations: true
---

```{r include=FALSE, echo=FALSE}
# NO CHUNK LABEL - prevents duplicate label errors
if (!exists("project")) stop("Project object not found")
library(knitr)

get_field <- function(fname) {
  val <- project[[fname]]
  if (is.null(val) || length(val) == 0 || is.na(val) || val == "") return(NA_character_)
  return(as.character(val))
}
```

### Project `r get_field("project_id") %||% "UNKNOWN"` {#`r get_field("project_id") %||% "unknown"`}

## `r get_field("project_title") %||% "Untitled Project"`

```{r echo=FALSE, results='asis', warning=FALSE, message=FALSE}
# Simple metadata
meta_fields <- list(
  c("Project Leads", "project_leads"),
  c("Collaborations", "collaborations"),
  c("Region", "region"),
  c("Stock", "stock"),
  c("Population", "population"),
  c("Conservation Unit", "cu"),
  c("Life History", "life_history")
)

for (mf in meta_fields) {
  val <- get_field(mf[2])
  if (!is.na(val)) cat("**", mf[1], ":** ", val, "\n\n", sep = "")
}

# List fields
list_fields <- list(
  c("Species", "species"),
  c("Waterbodies", "waterbodies"),
  c("Location", "location")
)

for (lf in list_fields) {
  val <- get_field(lf[2])
  if (!is.na(val)) {
    if (grepl("[;,]", val)) {
      items <- trimws(strsplit(val, "[;,]")[[1]])
      items <- items[nchar(items) > 0]
      if (length(items) > 0) {
        cat("**", lf[1], ":**\n\n", sep = "")
        for (item in items) cat("- ", item, "\n", sep = "")
        cat("\n")
      }
    } else {
      cat("**", lf[1], ":** ", val, "\n\n", sep = "")
    }
  }
}
```

```{r echo=FALSE, results='asis', warning=FALSE, message=FALSE}
# Content sections with line breaks
content_fields <- list(
  c("Highlights", "highlights"),
  c("Background", "background"),
  c("Methods and Findings", "methods_findings"),
  c("Insights", "insights"),
  c("Next Steps", "next_steps"),
  c("Tables and Figures", "tables_figures"),
  c("References", "references")
)

for (cf in content_fields) {
  heading <- cf[1]
  field_name <- cf[2]
  
  text <- get_field(field_name)
  if (is.na(text)) next
  
  text <- trimws(text)
  if (nchar(text) == 0) next
  
  # Output section heading
  cat("**", heading, "**\n\n", sep = "")
  
  # Split on newlines
  lines <- strsplit(text, "\n", fixed = TRUE)[[1]]
  
  # Output each line as a paragraph
  for (line in lines) {
    line <- trimws(line)
    if (nchar(line) > 0) {
      cat(line, "\n\n", sep = "")
    } else {
      # Empty line = extra spacing
      cat("\n")
    }
  }
}
```
