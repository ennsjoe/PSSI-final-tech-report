
`r officer::run_bookmark(project$project_id, officer::ftext(""))`

### `r display_id(project$project_id)`

```{r proj-banner, echo=FALSE, message=FALSE, warning=FALSE}

if (exists("make_project_banner") && !is.null(SECTION_ICON_MAP)) {

  banner_ft <- tryCatch({
    make_project_banner(
      project    = project,
      icon_map   = SECTION_ICON_MAP,
      banner_dir = BANNER_DIR
    )
  }, error = function(e) {
    message("Banner failed for ", project$project_id, ": ", e$message)
    NULL
  })

  if (!is.null(banner_ft)) {
    # Directly call knit_print without wrapping it in print()
    knitr::knit_print(banner_ft) 
  }

}
```

<br>

```{r proj-content, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Helpers ───────────────────────────────────────────────────────────────────

safe_text <- function(value) {
  if (is.null(value) || is.na(value)) return(NULL)
  text <- as.character(value)
  if (nchar(trimws(text)) > 0) return(text)
  return(NULL)
}

render_section <- function(heading, text) {
  if (is.null(text)) return()
  cat("####", heading, "\n\n")
  lines <- strsplit(text, "\n", fixed = TRUE)[[1]]
  for (line in lines) {
    line <- trimws(line)
    if (nchar(line) > 0) cat(line, "\n\n") else cat("\n")
  }
}

# ── Metadata block ────────────────────────────────────────────────────────────

metadata_items <- c()

if (!is.null(safe_text(project$project_leads)))
  metadata_items <- c(metadata_items,
                      paste0("**Project Leads:** ", safe_text(project$project_leads)))

if (!is.null(safe_text(project$collaborations)))
  metadata_items <- c(metadata_items,
                      paste0("**Collaborations:** ", safe_text(project$collaborations)))

if (!is.null(safe_text(project$location)))
  metadata_items <- c(metadata_items,
                      paste0("**Location:** ", safe_text(project$location)))

if (!is.null(safe_text(project$region)))
  metadata_items <- c(metadata_items,
                      paste0("**Region:** ", safe_text(project$region)))

if (!is.null(safe_text(project$species)))
  metadata_items <- c(metadata_items,
                      paste0("**Species:** ", safe_text(project$species)))

if (!is.null(safe_text(project$waterbodies)))
  metadata_items <- c(metadata_items,
                      paste0("**Waterbodies:** ", safe_text(project$waterbodies)))

if (!is.null(safe_text(project$life_history)))
  metadata_items <- c(metadata_items,
                      paste0("**Life History:** ", safe_text(project$life_history)))

if (!is.null(safe_text(project$stock)))
  metadata_items <- c(metadata_items,
                      paste0("**Stock:** ", safe_text(project$stock)))

if (!is.null(safe_text(project$population)))
  metadata_items <- c(metadata_items,
                      paste0("**Population:** ", safe_text(project$population)))

if (!is.null(safe_text(project$cu)))
  metadata_items <- c(metadata_items,
                      paste0("**Conservation Unit:** ", safe_text(project$cu)))

if (length(metadata_items) > 0)
  cat(paste(metadata_items, collapse = " \n\n "), "\n\n")

# ── Content sections ──────────────────────────────────────────────────────────

render_section("Highlights",           safe_text(project$highlights))
render_section("Background",           safe_text(project$background))
render_section("Methods and Findings", safe_text(project$methods_findings))
```

```{r proj-figures, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Tables and figures ────────────────────────────────────────────────────────

# Resolve figure directory using bare project number (strip DFO_ prefix)
fig_project_id <- if (!is.null(project$project_number) && !is.na(project$project_number)) {
  as.character(project$project_number)
} else {
  gsub("^DFO_", "", project$project_id)
}

fig_dir             <- here::here("figures", "project_figures", fig_project_id)
has_files           <- dir.exists(fig_dir) && length(list.files(fig_dir)) > 0
tables_figures_text <- safe_text(project$tables_figures)

if (has_files || !is.null(tables_figures_text)) {

  cat("#### Tables and Figures\n\n")

  # Build caption lookup from tables_figures text field
  caption_map <- list()
  if (!is.null(tables_figures_text)) {
    for (line in trimws(strsplit(tables_figures_text, "\n", fixed = TRUE)[[1]])) {
      m <- regexec(
        "^(Figure|Fig|Table|Tbl)\\s*(\\d+)\\s*[:.\\-]\\s*(.+)$",
        line, ignore.case = TRUE
      )
      if (m[[1]][1] != -1) {
        parts <- regmatches(line, m)[[1]]
        caption_map[[paste(tolower(parts[2]), parts[3])]] <- trimws(parts[4])
      }
    }
  }

  if (has_files) {

    all_files   <- list.files(fig_dir, full.names = TRUE)
    img_files   <- sort(all_files[grepl("\\.(png|jpg|jpeg|gif|svg)$", all_files, ignore.case = TRUE)])
    table_files <- sort(all_files[grepl("\\.(csv|xlsx|xls)$",         all_files, ignore.case = TRUE)])

    for (file_path in c(table_files, img_files)) {

      file_name <- basename(file_path)
      file_ext  <- tolower(tools::file_ext(file_path))

      # Look up caption by filename convention (e.g. "Figure_1_..." -> key "figure 1")
      caption <- NULL
      fm <- regexec("(Figure|Fig|Table|Tbl)\\s*(\\d+)", file_name, ignore.case = TRUE)
      if (fm[[1]][1] != -1) {
        parts   <- regmatches(file_name, fm)[[1]]
        key     <- paste(tolower(parts[2]), parts[3])
        caption <- caption_map[[key]]
      }
      if (is.null(caption) || nchar(caption) == 0)
        caption <- tools::file_path_sans_ext(file_name)

      tryCatch({
        if (file_ext %in% c("xlsx", "xls")) {
          tbl_data <- openxlsx::read.xlsx(file_path, sheet = 1)
          ft <- flextable::flextable(tbl_data)
          ft <- flextable::autofit(flextable::theme_booktabs(ft))
          ft <- flextable::set_caption(ft, caption = caption)
          print(knitr::knit_print(ft))
          cat("\n\n")

        } else if (file_ext == "csv") {
          cat("**", caption, "**\n\n", sep = "")
          print(knitr::kable(
            read.csv(file_path, stringsAsFactors = FALSE, check.names = FALSE),
            format = "pandoc", row.names = FALSE
          ))
          cat("\n\n")

        } else if (file_ext %in% c("png", "jpg", "jpeg", "gif", "svg")) {
          rel_path <- gsub(paste0("^", here::here()), "", file_path)
          rel_path <- gsub("^[\\\\/]+", "", rel_path)
          rel_path <- gsub("\\\\", "/", rel_path)
          cat("![", caption, "](", rel_path, ")\n\n", sep = "")
        }

      }, error = function(e) {
        message("  Warning: could not load ", file_name, ": ", e$message)
        cat("*[Could not load ", file_name, "]*\n\n", sep = "")
      })
    }

  } else if (!is.null(tables_figures_text)) {
    # No figure directory - render raw text from the form field
    for (line in trimws(strsplit(tables_figures_text, "\n", fixed = TRUE)[[1]])) {
      if (nchar(line) > 0) cat(line, "\n\n")
    }
  }
}
```

```{r proj-closing, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Closing sections ──────────────────────────────────────────────────────────

render_section("Insights",   safe_text(project$insights))
render_section("Next Steps", safe_text(project$next_steps))

# References
references_text <- safe_text(project$references)
if (!is.null(references_text)) {
  cat("#### References\n\n")
  refs <- trimws(strsplit(references_text, "\n\n")[[1]])
  refs <- refs[nchar(refs) > 0]
  for (ref in refs) {
    cat("::: {custom-style=\"Bibliography\"}\n")
    cat(ref, "\n")
    cat(":::\n\n")
  }
}
```