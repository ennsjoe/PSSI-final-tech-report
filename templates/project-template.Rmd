
### Project `r project$project_id`: `r project$project_title`

```{r, results='asis', echo=FALSE}
# Helper function to safely extract text from project data
safe_text <- function(value) {
  if (is.null(value) || is.na(value)) return(NULL)
  text <- as.character(value)
  if (nchar(text) > 0) return(text)
  return(NULL)
}

# Display project metadata
metadata_items <- c()

if (!is.null(safe_text(project$project_leads))) {
  metadata_items <- c(metadata_items, paste0("**Project Leads:** ", safe_text(project$project_leads)))
}

if (!is.null(safe_text(project$collaborations))) {
  metadata_items <- c(metadata_items, paste0("**Collaborations:** ", safe_text(project$collaborations)))
}

if (!is.null(safe_text(project$location))) {
  metadata_items <- c(metadata_items, paste0("**Location:** ", safe_text(project$location)))
}

if (!is.null(safe_text(project$region))) {
  metadata_items <- c(metadata_items, paste0("**Region:** ", safe_text(project$region)))
}

if (!is.null(safe_text(project$species))) {
  metadata_items <- c(metadata_items, paste0("**Species:** ", safe_text(project$species)))
}

if (!is.null(safe_text(project$waterbodies))) {
  metadata_items <- c(metadata_items, paste0("**Waterbodies:** ", safe_text(project$waterbodies)))
}

if (!is.null(safe_text(project$life_history))) {
  metadata_items <- c(metadata_items, paste0("**Life History:** ", safe_text(project$life_history)))
}

if (!is.null(safe_text(project$stock))) {
  metadata_items <- c(metadata_items, paste0("**Stock:** ", safe_text(project$stock)))
}

if (!is.null(safe_text(project$population))) {
  metadata_items <- c(metadata_items, paste0("**Population:** ", safe_text(project$population)))
}

if (!is.null(safe_text(project$cu))) {
  metadata_items <- c(metadata_items, paste0("**Conservation Unit:** ", safe_text(project$cu)))
}

if (length(metadata_items) > 0) {
  cat(paste(metadata_items, collapse = " \n\n "), "\n\n")
}

# Highlights section
highlights_text <- safe_text(project$highlights)
if (!is.null(highlights_text)) {
  cat("#### Highlights\n\n")
  cat(highlights_text, "\n\n")
}

# Background section
background_text <- safe_text(project$background)
if (!is.null(background_text)) {
  cat("#### Background\n\n")
  cat(background_text, "\n\n")
}

# Methods and Findings section
methods_text <- safe_text(project$methods_findings)
if (!is.null(methods_text)) {
  cat("#### Methods and Findings\n\n")
  cat(methods_text, "\n\n")
}
```

```{r, results='asis', echo=FALSE}
# Tables and Figures section - SIMPLIFIED file loading
fig_dir <- here::here("figures", "project_figures", project$project_id)

# Check if directory exists
has_files <- dir.exists(fig_dir)
tables_figures_text <- safe_text(project$tables_figures)

if (has_files || !is.null(tables_figures_text)) {
  cat("#### Tables and Figures\n\n")
  
  if (has_files) {
    # Get all files (images and tables)
    all_files <- list.files(fig_dir, full.names = TRUE)
    
    # Filter for supported file types
    img_pattern <- "\\.(png|jpg|jpeg|gif|svg)$"
    table_pattern <- "\\.(csv|xlsx|xls)$"
    
    img_files <- all_files[grepl(img_pattern, all_files, ignore.case = TRUE)]
    table_files <- all_files[grepl(table_pattern, all_files, ignore.case = TRUE)]
    
    # Combine and sort: tables first, then images
    all_files <- c(table_files, img_files)
    
    # Process each file individually (no complex grouping logic)
    for (file_path in all_files) {
      file_name <- tools::file_path_sans_ext(basename(file_path))
      file_ext <- tolower(tools::file_ext(file_path))
      
      tryCatch({
        if (file_ext %in% c("xlsx", "xls")) {
          # Excel table
          if (requireNamespace("openxlsx", quietly = TRUE) && 
              requireNamespace("flextable", quietly = TRUE)) {
            table_data <- openxlsx::read.xlsx(file_path, sheet = 1)
            ft <- flextable::flextable(table_data)
            ft <- flextable::autofit(ft)
            ft <- flextable::theme_booktabs(ft)
            flextable::knit_print.flextable(ft)
            cat("\n\n")
          }
        } else if (file_ext == "csv") {
          # CSV table
          table_data <- read.csv(file_path, stringsAsFactors = FALSE, check.names = FALSE)
          print(knitr::kable(table_data, format = "pandoc", row.names = FALSE))
          cat("\n\n")
        } else if (file_ext %in% c("png", "jpg", "jpeg", "gif", "svg")) {
          # Image
          cat("![](", file_path, ")\n\n", sep = "")
        }
        
        # Add caption as filename (you can enhance this later)
        cat("**", file_name, "**\n\n", sep = "")
        
      }, error = function(e) {
        cat("\n\n*Error loading file ", basename(file_path), ": ", e$message, "*\n\n", sep = "")
      })
    }
  }
  
  # Also show text content if present
  if (!is.null(tables_figures_text)) {
    cat("\n\n", tables_figures_text, "\n\n")
  }
}
```

```{r, results='asis', echo=FALSE}
# Insights section
insights_text <- safe_text(project$insights)
if (!is.null(insights_text)) {
  cat("#### Insights\n\n")
  cat(insights_text, "\n\n")
}

# Next Steps section
next_steps_text <- safe_text(project$next_steps)
if (!is.null(next_steps_text)) {
  cat("#### Next Steps\n\n")
  cat(next_steps_text, "\n\n")
}

# References section
references_text <- safe_text(project$references)
if (!is.null(references_text)) {
  cat("#### References\n\n")
  
  # Split references by double line breaks
  refs <- strsplit(references_text, "\n\n")[[1]]
  refs <- trimws(refs)
  refs <- refs[refs != ""]
  
  # Display each reference
  for (ref in refs) {
    cat("::: {custom-style=\"Bibliography\"}\n")
    cat(ref, "\n")
    cat(":::\n\n")
  }
}
```

\newpage
