
### `r project$project_number`: `r project$project_title`

```{r echo=FALSE, results='asis'}
# tryCatch({
#   bkm <- as.character(project$project_id)  # e.g., "DFO_3994"
# 
#   if (knitr::is_html_output()) {
#     # HTML anchor (if you ever render HTML)
#     cat(sprintf('<a id="%s"></a>\n', bkm))
# 
#   } else if (knitr::is_latex_output()) {
#     # LaTeX anchor (if you ever render PDF)
#     cat(sprintf('\\hypertarget{%s}{} \n', bkm))
# 
#   } else {
#     # Word (officedown::rdocx_document): MUST force-print the run
#     officedown::knit_print_run(
#       officer::run_bookmark(
#         bkm,
#         officer::ftext(
#           "",  # empty text; bookmark still exists at this location
#           officer::fp_text(font.size = 1, color = "white")
#         )
#       )
#     )
#   }
# 
# }, error = function(e) invisible(NULL))

# Just use a standard div with an ID. 
# Pandoc/Word will turn this into a bookmark/anchor.
cat(paste0("\n\n::: {#", project$project_id, "}\n:::\n\n"))

```

```{r echo=FALSE, results='asis'}
# Helper function to safely extract text from project data
safe_text <- function(value) {
  if (is.null(value) || is.na(value)) return(NULL)
  text <- as.character(value)
  if (nchar(text) > 0) return(text)
  return(NULL)
}

# Check if this project has extracted content
has_content <- !is.na(project$highlights) || 
               !is.na(project$background) || 
               !is.na(project$methods_findings)

# For projects WITHOUT extracted content, show minimal placeholder
if (!has_content) {
  cat("\n**Project Status:** Detailed report pending content extraction.\n\n")
  
  # Show whatever metadata fields are available from tracking list
  if (!is.null(safe_text(project$description))) {
    cat("**Description:** ", safe_text(project$description), "\n\n")
  }
  
  if (!is.null(safe_text(project$recipient))) {
    cat("**Recipient:** ", safe_text(project$recipient), "\n\n")
  }
  
  if (!is.null(safe_text(project$location))) {
    cat("**Location:** ", safe_text(project$location), "\n\n")
  }
  
  if (!is.null(safe_text(project$geographic_distribution))) {
    cat("**Geographic Distribution:** ", safe_text(project$geographic_distribution), "\n\n")
  }
  
  if (!is.null(safe_text(project$collaborators))) {
    cat("**Collaborators:** ", safe_text(project$collaborators), "\n\n")
  }
}
```

```{r results='asis', echo=FALSE}
# Display project metadata from extracted content
metadata_items <- c()

if (!is.null(safe_text(project$project_leads))) {
  metadata_items <- c(metadata_items, paste0("**Project Leads:** ", safe_text(project$project_leads)))
}

if (!is.null(safe_text(project$collaborations))) {
  metadata_items <- c(metadata_items, paste0("**Collaborations:** ", safe_text(project$collaborations)))
}

if (!is.null(safe_text(project$location))) {
  metadata_items <- c(metadata_items, paste0("**Location:** ", safe_text(project$location)))
}

if (!is.null(safe_text(project$region))) {
  metadata_items <- c(metadata_items, paste0("**Region:** ", safe_text(project$region)))
}

if (!is.null(safe_text(project$species))) {
  metadata_items <- c(metadata_items, paste0("**Species:** ", safe_text(project$species)))
}

if (!is.null(safe_text(project$waterbodies))) {
  metadata_items <- c(metadata_items, paste0("**Waterbodies:** ", safe_text(project$waterbodies)))
}

if (!is.null(safe_text(project$life_history))) {
  metadata_items <- c(metadata_items, paste0("**Life History:** ", safe_text(project$life_history)))
}

if (!is.null(safe_text(project$stock))) {
  metadata_items <- c(metadata_items, paste0("**Stock:** ", safe_text(project$stock)))
}

if (!is.null(safe_text(project$population))) {
  metadata_items <- c(metadata_items, paste0("**Population:** ", safe_text(project$population)))
}

if (!is.null(safe_text(project$cu))) {
  metadata_items <- c(metadata_items, paste0("**Conservation Unit:** ", safe_text(project$cu)))
}

if (length(metadata_items) > 0) {
  cat(paste(metadata_items, collapse = " \n\n "), "\n\n")
}

# Highlights section
highlights_text <- safe_text(project$highlights)
if (!is.null(highlights_text)) {
  cat("#### Highlights\n\n")
  cat(highlights_text, "\n\n")
}

# Background section
background_text <- safe_text(project$background)
if (!is.null(background_text)) {
  cat("#### Background\n\n")
  cat(background_text, "\n\n")
}

# Methods and Findings section
methods_text <- safe_text(project$methods_findings)
if (!is.null(methods_text)) {
  cat("#### Methods and Findings\n\n")
  cat(methods_text, "\n\n")
}
```

```{r results='asis', echo=FALSE}
# Tables and Figures section
fig_dir <- here::here("figures", "project_figures", project$project_id)

# Check if directory exists and has content
has_files <- FALSE
img_files <- character(0)
table_files <- character(0)

if (dir.exists(fig_dir)) {
  img_files <- list.files(fig_dir, 
                          pattern = "\\.(png|jpg|jpeg|gif|svg)$", 
                          full.names = TRUE, 
                          ignore.case = TRUE)
  
  table_files <- list.files(fig_dir, 
                            pattern = "\\.(csv|xlsx|xls)$", 
                            full.names = TRUE, 
                            ignore.case = TRUE)
  
  has_files <- length(img_files) > 0 || length(table_files) > 0
}

# Also check for text-only tables_figures content
tables_figures_text <- safe_text(project$tables_figures)
has_text_content <- !is.null(tables_figures_text)

if (has_files || has_text_content) {
  cat("#### Tables and Figures\n\n")
  
  # Parse captions from tables_figures field
  captions <- NULL
  if (has_text_content) {
    captions <- strsplit(tables_figures_text, "\n")[[1]]
    captions <- trimws(captions)
    captions <- captions[captions != ""]
  }
  
  # Helper function to find matching caption
  find_caption <- function(file_name, captions) {
    if (is.null(captions)) return(file_name)
    
    base_name <- file_name
    if (grepl("[a-zA-Z]$", file_name)) {
      base_name <- substr(file_name, 1, nchar(file_name) - 1)
    }
    
    search_pattern <- gsub("_", " ", base_name)
    match_idx <- grep(paste0("^", search_pattern), captions, ignore.case = TRUE)
    
    if (length(match_idx) > 0) {
      return(captions[match_idx[1]])
    }
    
    return(file_name)
  }
  
  # Combine all files
  all_files <- c(table_files, img_files)
  
  if (length(all_files) > 0) {
    file_order <- order(
      !grepl("^Table", basename(all_files), ignore.case = TRUE),
      as.numeric(gsub("\\D", "", basename(all_files)))
    )
    all_files <- all_files[file_order]
    
    # Process files in groups
    i <- 1
    while (i <= length(all_files)) {
      file_path <- all_files[i]
      file_name <- tools::file_path_sans_ext(basename(file_path))
      file_ext <- tolower(tools::file_ext(file_path))
      
      base_name <- file_name
      has_suffix <- grepl("[a-zA-Z]$", file_name)
      
      if (has_suffix) {
        base_name <- substr(file_name, 1, nchar(file_name) - 1)
      }
      
      # Find all files with the same base name
      group_files <- c(file_path)
      j <- i + 1
      while (j <= length(all_files)) {
        next_file_name <- tools::file_path_sans_ext(basename(all_files[j]))
        next_base <- next_file_name
        if (grepl("[a-zA-Z]$", next_file_name)) {
          next_base <- substr(next_file_name, 1, nchar(next_file_name) - 1)
        }
        if (next_base == base_name) {
          group_files <- c(group_files, all_files[j])
          j <- j + 1
        } else {
          break
        }
      }
      
      # Process the group of files
      tryCatch({
        for (gf in group_files) {
          gf_ext <- tolower(tools::file_ext(gf))
          
          if (gf_ext %in% c("xlsx", "xls")) {
            if (requireNamespace("openxlsx", quietly = TRUE) && 
                requireNamespace("flextable", quietly = TRUE)) {
              table_data <- openxlsx::read.xlsx(gf, sheet = 1)
              ft <- flextable::flextable(table_data)
              ft <- flextable::autofit(ft)
              ft <- flextable::theme_booktabs(ft)
              #flextable::knit_print.flextable(ft)
              print(ft)
              cat("\n\n")
            }
          } else if (gf_ext == "csv") {
            table_data <- read.csv(gf, stringsAsFactors = FALSE, check.names = FALSE)
            print(knitr::kable(table_data, format = "pandoc", row.names = FALSE))
            cat("\n\n")
          } else if (gf_ext %in% c("png", "jpg", "jpeg", "gif", "svg")) {
            cat("![](", gf, ")\n\n", sep = "")
          }
        }
        
        caption <- find_caption(file_name, captions)
        cat("**", caption, "**\n\n", sep = "")
        
      }, error = function(e) {
        cat("\n\n*Error loading file: ", e$message, "*\n\n", sep = "")
      })
      
      i <- j
    }
  }
  
  if (!has_files && has_text_content) {
    cat(tables_figures_text, "\n\n")
  }
}
```

```{r results='asis', echo=FALSE}
# Insights section
insights_text <- safe_text(project$insights)
if (!is.null(insights_text)) {
  cat("#### Insights\n\n")
  cat(insights_text, "\n\n")
}

# Next Steps section
next_steps_text <- safe_text(project$next_steps)
if (!is.null(next_steps_text)) {
  cat("#### Next Steps\n\n")
  cat(next_steps_text, "\n\n")
}

# References section
references_text <- safe_text(project$references)
if (!is.null(references_text)) {
  cat("#### References\n\n")
  
  refs <- strsplit(references_text, "\n\n")[[1]]
  refs <- trimws(refs)
  refs <- refs[refs != ""]
  
  for (ref in refs) {
    cat("::: {custom-style=\"Bibliography\"}\n")
    cat(ref, "\n")
    cat(":::\n\n")
  }
}
```
