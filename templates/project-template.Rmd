
### `r display_id(project$project_id)`

```{r proj-banner, echo=FALSE, message=FALSE, warning=FALSE}

if (exists("make_project_banner") && exists("SECTION_ICON_MAP") && 
    !is.null(SECTION_ICON_MAP)) {

  banner_ft <- tryCatch({
    make_project_banner(
      project    = project,
      icon_map   = SECTION_ICON_MAP,
      banner_dir = BANNER_DIR
    )
  }, error = function(e) {
    message("Banner failed for ", project$project_id, ": ", e$message)
    NULL
  })

  if (!is.null(banner_ft)) {
    knitr::knit_print(banner_ft) 
  }

}
```

<br>

```{r proj-content, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Helpers ───────────────────────────────────────────────────────────────────

safe_text <- function(value) {
  # Return NULL for actual NULL or missing values
  if (is.null(value)) return(NULL)
  
  # Convert to character
  text <- as.character(value)
  
  # Return NULL if length is 0 (e.g., from as.character(NULL))
  if (length(text) == 0) return(NULL)
  
  # Return NULL for NA values
  if (is.na(text)) return(NULL)
  
  # Return NULL for literal strings "NULL", "NA", "<NA>"
  if (toupper(trimws(text)) %in% c("NULL", "NA", "<NA>")) return(NULL)
  
  # Return NULL for empty or whitespace-only strings
  if (nchar(trimws(text)) == 0) return(NULL)
  
  # Otherwise return the trimmed text
  return(trimws(text))
}

render_section <- function(heading, text) {
  if (is.null(text)) return(invisible(NULL))
  cat("####", heading, "\n\n")
  lines <- strsplit(text, "\n", fixed = TRUE)[[1]]
  for (line in lines) {
    line <- trimws(line, which = "right")  # preserve leading indent for nested bullets
    if (nchar(trimws(line)) == 0) {
      cat("\n")
    } else if (grepl("^\\s*- ", line)) {
      cat(line, "\n")                      # tight newline keeps bullet levels in one list
    } else {
      cat(line, "\n\n")                    # double newline for regular paragraphs
    }
  }
  cat("\n\n")                              # ensure blank line after section so next heading renders correctly
  return(invisible(NULL))
}

# Table rendering using flextable — matches make_section_table styling.
#
# Output note: flextable_to_rmd() is used (not knitr::knit_print) because
# knit_print() returns a knit_asis object that must be printed at the top
# level to have any effect — it silently produces nothing when called inside
# a function. flextable_to_rmd() writes directly to the knitr output stream
# and works correctly from within a function in a results='asis' chunk,
# including inside knit_child() calls.
render_word_table <- function(
    data,
    caption,
    table_number     = NULL,
    header_bg        = "#1F497D",
    header_fg        = "white",
    font_size_body   = 9,
    font_size_header = 9,
    pad              = 3
) {

  if (is.null(data) || nrow(data) == 0 || ncol(data) == 0) {
    if (!is.null(table_number)) {
      cat("Table ", table_number, ". ", caption, "\n\n")
    } else {
      cat(caption, "\n\n")
    }
    cat("*[No data available]*\n\n")
    return(invisible(NULL))
  }

  # Clean data
  clean_data <- as.data.frame(data, stringsAsFactors = FALSE)

  # Fix missing or blank column names
  if (any(is.na(names(clean_data))) || any(names(clean_data) == "")) {
    names(clean_data) <- paste0("Column", seq_along(clean_data))
  }

  # Clean cell values
  for (i in seq_along(clean_data)) {
    clean_data[[i]] <- as.character(clean_data[[i]])
    clean_data[[i]][is.na(clean_data[[i]])] <- ""
    clean_data[[i]] <- gsub("[\r\n\t]", " ", clean_data[[i]])
    clean_data[[i]] <- trimws(clean_data[[i]])
  }

  # Limit rows with a note if truncated
  max_rows  <- 40
  truncated <- nrow(clean_data) > max_rows
  if (truncated) clean_data <- clean_data[1:max_rows, ]

  # Caption — output as plain paragraph before the table
  if (!is.null(table_number)) {
    cat("Table ", table_number, ". ", caption, "\n\n")
  } else {
    cat(caption, "\n\n")
  }

  # Build flextable styled to match make_section_table
  ft <- flextable::flextable(clean_data) %>%
    flextable::bold(part = "header") %>%
    flextable::fontsize(size = font_size_header, part = "header") %>%
    flextable::bg(bg = header_bg, part = "header") %>%
    flextable::color(color = header_fg, part = "header") %>%
    flextable::align(align = "left", part = "header") %>%
    flextable::fontsize(size = font_size_body, part = "body") %>%
    flextable::align(align = "left", part = "body") %>%
    flextable::valign(valign = "top", part = "body") %>%
    flextable::padding(padding = pad, part = "all") %>%
    flextable::border_outer(
      part   = "all",
      border = officer::fp_border(color = "#BFBFBF", width = 1)
    ) %>%
    flextable::border_inner_h(
      part   = "all",
      border = officer::fp_border(color = "#E0E0E0", width = 0.75)
    ) %>%
    flextable::border_inner_v(
      part   = "all",
      border = officer::fp_border(color = "#E0E0E0", width = 0.75)
    ) %>%
    flextable::autofit() %>%
    flextable::set_table_properties(layout = "autofit")

  flextable::flextable_to_rmd(ft)

  if (truncated) {
    cat("\n\n*[Showing first", max_rows, "rows of", nrow(data), "total rows]*\n\n")
  }

  return(invisible(NULL))
}

# ── Metadata block ────────────────────────────────────────────────────────────

# Project Leads — rendered first so Collaborations can follow immediately after
if (!is.null(safe_text(project$project_leads)))
  cat("**Project Leads:**", safe_text(project$project_leads), "\n\n")

# Collaborations — rendered as a section to support bullet lists
invisible(render_section("Collaborations and External Partners", safe_text(project$collaborations)))

# Remaining metadata fields
metadata_items <- c()

if (!is.null(safe_text(project$location)))
  metadata_items <- c(metadata_items,
                      paste0("**Location:** ", safe_text(project$location)))

if (!is.null(safe_text(project$region)))
  metadata_items <- c(metadata_items,
                      paste0("**Region:** ", safe_text(project$region)))

if (!is.null(safe_text(project$species)))
  metadata_items <- c(metadata_items,
                      paste0("**Species:** ", safe_text(project$species)))

if (!is.null(safe_text(project$waterbodies)))
  metadata_items <- c(metadata_items,
                      paste0("**Waterbodies:** ", safe_text(project$waterbodies)))

if (!is.null(safe_text(project$life_history)))
  metadata_items <- c(metadata_items,
                      paste0("**Life History:** ", safe_text(project$life_history)))

if (!is.null(safe_text(project$stock)))
  metadata_items <- c(metadata_items,
                      paste0("**Stock:** ", safe_text(project$stock)))

if (!is.null(safe_text(project$population)))
  metadata_items <- c(metadata_items,
                      paste0("**Population:** ", safe_text(project$population)))

if (!is.null(safe_text(project$cu)))
  metadata_items <- c(metadata_items,
                      paste0("**Conservation Unit:** ", safe_text(project$cu)))

if (length(metadata_items) > 0)
  cat(paste(metadata_items, collapse = " \n\n "), "\n\n")

# ── Content sections ──────────────────────────────────────────────────────────
invisible(render_section("Highlights",                           safe_text(project$highlights)))
invisible(render_section("Background",           safe_text(project$background)))
invisible(render_section("Methods and Findings", safe_text(project$methods_findings)))
```

```{r proj-figures, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Tables and figures ────────────────────────────────────────────────────────

# Resolve figure directory using bare project number (strip DFO_ prefix)
fig_project_id <- if (!is.null(project$project_number) && !is.na(project$project_number)) {
  as.character(project$project_number)
} else {
  gsub("^DFO_", "", project$project_id)
}

fig_dir             <- here::here("figures", "project_figures", fig_project_id)
has_files           <- dir.exists(fig_dir) && length(list.files(fig_dir)) > 0
tables_figures_text <- safe_text(project$tables_figures)

if (has_files || !is.null(tables_figures_text)) {

  cat("#### Tables and Figures\n\n")

  # Build caption lookup from tables_figures text field
  caption_map <- list()
  if (!is.null(tables_figures_text)) {
    for (line in trimws(strsplit(tables_figures_text, "\n", fixed = TRUE)[[1]])) {
      m <- regexec(
        "^(Figure|Fig|Table|Tbl)\\s*(\\d+)\\s*[:.\\-]\\s*(.+)$",
        line, ignore.case = TRUE
      )
      if (m[[1]][1] != -1) {
        parts <- regmatches(line, m)[[1]]
        caption_map[[paste(tolower(parts[2]), parts[3])]] <- trimws(parts[4])
      }
    }
  }

  if (has_files) {

    all_files   <- list.files(fig_dir, full.names = TRUE)
    img_files   <- sort(all_files[grepl("\\.(png|jpg|jpeg|gif|svg|tif|tiff)$", all_files, ignore.case = TRUE)])
    table_files <- sort(all_files[grepl("\\.(csv|xlsx|xls)$",         all_files, ignore.case = TRUE)])

    # Track table and figure numbers
    table_counter <- 1
    figure_counter <- 1

    for (file_path in c(table_files, img_files)) {

      file_name <- basename(file_path)
      file_ext  <- tolower(tools::file_ext(file_path))

      # Look up caption by filename convention
      caption <- NULL
      table_number <- NULL
      figure_number <- NULL
      
      fm <- regexec("(Figure|Fig|Table|Tbl)\\s*(\\d+)", file_name, ignore.case = TRUE)
      if (fm[[1]][1] != -1) {
        parts <- regmatches(file_name, fm)[[1]]
        key <- paste(tolower(parts[2]), parts[3])
        caption <- caption_map[[key]]
        
        # Extract number for proper display
        if (tolower(parts[2]) %in% c("table", "tbl")) {
          table_number <- parts[3]
        } else if (tolower(parts[2]) %in% c("figure", "fig")) {
          figure_number <- parts[3]
        }
      }
      
      if (is.null(caption) || nchar(caption) == 0) {
        caption <- tools::file_path_sans_ext(file_name)
      }

      tryCatch({
        if (file_ext %in% c("xlsx", "xls")) {
          
          message("Processing Excel file: ", file_name)
          tbl_data <- openxlsx::read.xlsx(file_path, sheet = 1)
          
          # Use extracted table number or auto-increment
          if (is.null(table_number)) {
            table_number <- table_counter
            table_counter <- table_counter + 1
          }
          
          render_word_table(tbl_data, caption, table_number)

        } else if (file_ext == "csv") {
          
          message("Processing CSV file: ", file_name)
          csv_data <- read.csv(file_path, stringsAsFactors = FALSE, check.names = FALSE)
          
          # Use extracted table number or auto-increment
          if (is.null(table_number)) {
            table_number <- table_counter
            table_counter <- table_counter + 1
          }
          
          render_word_table(csv_data, caption, table_number)

        } else if (file_ext %in% c("png", "jpg", "jpeg", "gif", "svg", "tif", "tiff")) {
          
          rel_path <- gsub(paste0("^", here::here()), "", file_path)
          rel_path <- gsub("^[\\\\/]+", "", rel_path)
          rel_path <- gsub("\\\\", "/", rel_path)
          
          # Use extracted figure number or auto-increment
          if (is.null(figure_number)) {
            figure_number <- figure_counter
            figure_counter <- figure_counter + 1
          }
          cat("![](", rel_path, ")\n\n", sep = "")
          cat("::: {custom-style=\"Caption\"}\n")
          cat("Figure ", figure_number, ". ", caption, "\n")
          cat(":::\n\n")
        }

      }, error = function(e) {
        message("  Warning: could not load ", file_name, ": ", e$message)
        cat(caption, "\n\n")
        cat("*[Could not load ", file_name, ": ", e$message, "]*\n\n")
      })
    }

  } else if (!is.null(tables_figures_text)) {
    # Render text from form field (like project 2408)
    for (line in trimws(strsplit(tables_figures_text, "\n", fixed = TRUE)[[1]])) {
      if (nchar(line) > 0) cat(line, "\n\n")
    }
  }
}
```

```{r proj-closing, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# ── Closing sections ──────────────────────────────────────────────────────────

invisible(render_section("Insights",   safe_text(project$insights)))
invisible(render_section("Next Steps", safe_text(project$next_steps)))

# References
references_text <- safe_text(project$references)
if (!is.null(references_text)) {
  cat("#### References\n\n")
  refs <- trimws(strsplit(references_text, "\n\n")[[1]])
  refs <- refs[nchar(refs) > 0]
  for (ref in refs) {
    cat("::: {custom-style=\"Bibliography\"}\n")
    cat(ref, "\n")
    cat(":::\n\n")
  }
}
```
