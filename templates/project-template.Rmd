
### Project `r project$project_id`: \n\n `r project$project_title`
 
```{r, results='asis'}
# Display project metadata box
metadata_items <- c()

if (!is.na(project$project_leads) && nchar(project$project_leads) > 0) {
  metadata_items <- c(metadata_items, paste0("**Project Leads:** ", project$project_leads))
}

if (!is.na(project$collaborations) && nchar(project$collaborations) > 0) {
  metadata_items <- c(metadata_items, paste0("**Collaborations:** ", project$collaborations))
}

if (!is.na(project$location) && nchar(project$location) > 0) {
  metadata_items <- c(metadata_items, paste0("**Location:** ", project$location))
}

if (!is.na(project$region) && nchar(project$region) > 0) {
  metadata_items <- c(metadata_items, paste0("**Region:** ", project$region))
}

if (!is.na(project$species) && nchar(project$species) > 0) {
  metadata_items <- c(metadata_items, paste0("**Species:** ", project$species))
}

if (!is.na(project$waterbodies) && nchar(project$waterbodies) > 0) {
  metadata_items <- c(metadata_items, paste0("**Waterbodies:** ", project$waterbodies))
}

if (!is.na(project$life_history) && nchar(project$life_history) > 0) {
  metadata_items <- c(metadata_items, paste0("**Life History:** ", project$life_history))
}

if (!is.na(project$stock) && nchar(project$stock) > 0) {
  metadata_items <- c(metadata_items, paste0("**Stock:** ", project$stock))
}

if (!is.na(project$population) && nchar(project$population) > 0) {
  metadata_items <- c(metadata_items, paste0("**Population:** ", project$population))
}

if (!is.na(project$cu) && nchar(project$cu) > 0) {
  metadata_items <- c(metadata_items, paste0("**Conservation Unit:** ", project$cu))
}

if (length(metadata_items) > 0) {
  cat(paste(metadata_items, collapse = " \n\n "), "\n\n")
}
```

```{r, results='asis'}
# Highlights
if (!is.na(project$highlights) && nchar(project$highlights) > 0) {
  cat("#### Highlights\n\n")
  cat(project$highlights, "\n\n")
}
```

```{r, results='asis'}
# Background
if (!is.na(project$background) && nchar(project$background) > 0) {
  cat("#### Background\n\n")
  cat(project$background, "\n\n")
}
```

```{r, results='asis'}
# Methods and Findings
if (!is.na(project$methods_findings) && nchar(project$methods_findings) > 0) {
  cat("#### Methods and Findings\n\n")
  cat(project$methods_findings, "\n\n")
}
```

```{r, results='asis'}
# Tables and Figures with images
fig_dir <- here("figures", "project_figures", project$project_id)

if (dir.exists(fig_dir)) {
  img_files <- list.files(fig_dir, pattern = "\\.(png|jpg|jpeg|gif)$", 
                          full.names = TRUE, ignore.case = TRUE)
  
  if (length(img_files) > 0) {
    cat("#### Tables and Figures\n\n")
    
    # Parse captions
    captions <- NULL
    if (!is.na(project$tables_figures) && nchar(project$tables_figures) > 0) {
      captions <- strsplit(project$tables_figures, "\n")[[1]]
      captions <- trimws(captions)
      captions <- captions[captions != ""]
    }
    
    for (img_path in sort(img_files)) {
      img_name <- tools::file_path_sans_ext(basename(img_path))
      
      # Find matching caption
      caption <- img_name
      if (!is.null(captions)) {
        match_idx <- grep(paste0("^", img_name), captions, ignore.case = TRUE)
        if (length(match_idx) > 0) {
          caption <- captions[match_idx[1]]
        }
      }
      
      cat("![", caption, "](", img_path, ")\n\n", sep = "")
    }
  }
} else if (!is.na(project$tables_figures) && nchar(project$tables_figures) > 0) {
  cat("#### Tables and Figures\n\n")
  cat(project$tables_figures, "\n\n")
}
```

```{r, results='asis'}
# Insights
if (!is.na(project$insights) && nchar(project$insights) > 0) {
  cat("#### Insights\n\n")
  cat(project$insights, "\n\n")
}
```

```{r, results='asis'}
# Next Steps
if (!is.na(project$next_steps) && nchar(project$next_steps) > 0) {
  cat("#### Next Steps\n\n")
  cat(project$next_steps, "\n\n")
}
```

```{r, results='asis'}
# References
if (!is.na(project$references) && nchar(project$references) > 0) {
  cat("#### References\n\n")
  cat(project$references, "\n\n")
}
```
