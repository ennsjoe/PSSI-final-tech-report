# APPENDIX A. Overview of Phase 2 BCSRIF Projects {#app-bcsrif}

```{r appendix-a-setup, include=FALSE}
knitr::opts_chunk$set(
  tab.cap.pre    = "Table A-",
  tab.cap.sep    = ": ",
  tab.lp         = "tabA:",
  tab.topcaption = TRUE,
  fig.cap.pre    = "Figure A-",
  fig.cap.sep    = ": ",
  fig.lp         = "figA:",
  fig.topcaption = TRUE
)
```

```{r bcsrif-table, echo=FALSE, tab.cap="BCSRIF Projects", tab.id="bcsrif-projects", tab.topcaption=TRUE}

# Use projects_df (already loaded by _common.R) so project_id values match
# exactly what add_table_row_bookmarks() will look for when injecting bookmarks.
if (!exists("projects_df") || nrow(projects_df) == 0) {

  cat("*No project data available. Ensure _common.R has been sourced.*\n")

} else {

  raw <- projects_df %>%
    filter(source == "BCSRIF", include %in% c("y", "Y")) %>%
    select(project_id, project_title, recipient, description, collaborators) %>%
    mutate(
      project_id    = str_squish(as.character(project_id)),
      project_title = str_squish(as.character(project_title)),
      recipient     = str_squish(as.character(recipient)),
      collaborators = str_squish(as.character(collaborators)),
      description   = str_squish(as.character(description))
    ) %>%
    mutate(across(everything(), ~ ifelse(is.na(.x), "", .x)))

  if (nrow(raw) > 0) {

    tbl <- raw %>%
      transmute(
        Project       = "",   # placeholder; filled with compose()
        Description   = description,
        project_id,
        project_title,
        recipient,
        collaborators
      )

    collab_line <- ifelse(tbl$collaborators == "", "", tbl$collaborators)

    sep_body   <- fp_border(color = "darkgrey", width = 0.5)
    sep_header <- fp_border(color = "black",    width = 0.9)

    # Global text props (uniform font & size)
    base_font  <- "Arial"   # change if you prefer e.g., "Calibri"
    base_size  <- 9

    ft <- flextable(tbl %>% select(Project, Description)) %>%
      set_caption("BCSRIF Projects") %>%
      set_header_labels(Project = "Project", Description = "Description") %>%

      # --- Project column content (ID, Title, Recipient) ---
      compose(
        j = "Project",
        value = as_paragraph(
          as_chunk(tbl$project_id, props = fp_text(bold = TRUE)),
          as_chunk("\n"),
          as_chunk("Title: ",     props = fp_text(bold = TRUE)),
          as_chunk(tbl$project_title),
          as_chunk("\n\n"),   # <-- extra line break between Title and Recipient
          as_chunk("Recipient: ", props = fp_text(bold = TRUE)),
          as_chunk(tbl$recipient)
        )
      ) %>%

      # --- Description column content (Description + Collaborators) ---
      compose(
        j = "Description",
        value = as_paragraph(
          as_chunk(tbl$Description),
          # Add a blank line only when there are collaborators
          as_chunk(ifelse(collab_line == "", "", "\n\n")),
          as_chunk(ifelse(collab_line == "", "", "Collaborators: "),
                   props = fp_text(bold = TRUE)),
          as_chunk(ifelse(collab_line == "", "", collab_line))
        )
      ) %>%

      # Header styling
      bold(part = "header") %>%
      align(part = "header", align = "left") %>%

      # Uniform typography across the table
      font(part = "all", fontname = base_font) %>%
      fontsize(part = "all", size = base_size) %>%

      # Spacing & alignment
      line_spacing(part = "all", space = 1.0) %>%
      padding(part = "all", padding = 3) %>%
      align(part = "all", align = "left") %>%
      valign(part = "all", valign = "top") %>%

      # Rules and widths
      border_inner_h(border = sep_body,   part = "body") %>%
      hline(i = 1, border = sep_header,   part = "header") %>%
      width(j = "Project",     width = 2) %>%
      width(j = "Description", width = 4.5)

    ft

  } else {
    cat("*No BCSRIF projects found with include = 'y'.*\n")
  }
}
```

\newpage
