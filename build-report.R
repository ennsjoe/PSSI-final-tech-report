#!/usr/bin/env Rscript
# build-report.R
# Master script to build PSSI Technical Report
# 
# This script:
# 1. Loads helper functions
# 2. Creates/updates _common.R (tracked in git but regenerated each build)
# 3. Initializes/updates the project database
# 4. Renders the report with Quarto

library(here)

cat("\n=== PSSI Technical Report Builder ===\n\n")

# Ensure we're in the project directory
project_root <- here::here()
cat("Working directory:", getwd(), "\n")
cat("Project root:", project_root, "\n\n")

# ===================================================================
# STEP 0: Pre-flight Checks
# ===================================================================

cat("Step 0: Pre-flight checks...\n")

# Check if _quarto.yml exists
quarto_config <- file.path(project_root, "_quarto.yml")
if (!file.exists(quarto_config)) {
  stop("\n‚ùå ERROR: _quarto.yml not found in project root!\n",
       "   Expected at: ", quarto_config, "\n",
       "   Make sure _quarto.yml is in the same directory as your .Rmd files.\n")
}
cat("  ‚úì Found _quarto.yml\n")

# Check if index.Rmd exists
index_file <- file.path(project_root, "index.Rmd")
if (!file.exists(index_file)) {
  stop("\n‚ùå ERROR: index.Rmd not found in project root!\n",
       "   Expected at: ", index_file, "\n")
}
cat("  ‚úì Found index.Rmd\n\n")

# ===================================================================
# STEP 1: Load Helper Functions
# ===================================================================

cat("Step 1: Loading helper functions...\n")
helper_file <- here("helper-functions", "helper-functions.R")

if (file.exists(helper_file)) {
  source(helper_file)
  cat("  ‚úì Helper functions loaded from:", helper_file, "\n\n")
} else {
  stop("  ‚ùå helper-functions.R not found at:", helper_file, "\n",
       "   Make sure helper-functions/helper-functions.R exists in your project\n")
}

# ===================================================================
# STEP 2: Create/Update _common.R
# ===================================================================

cat("Step 2: Creating/updating _common.R for chapters...\n")
common_file <- here("_common.R")

# Build the _common.R content as a single string for cleaner writing
common_content <- paste0(
  "# _common.R - Auto-generated by build-report.R\n",
  "# This file is regenerated on each build but tracked in version control\n",
  "# so it's available when knitting individual chapters.\n",
  "# Last updated: ", Sys.time(), "\n",
  "\n",
  "# ===================================================================\n",
  "# Package Loading with Auto-Install\n",
  "# ===================================================================\n",
  "\n",
  "# Helper function to install and load packages\n",
  "ensure_package <- function(pkg) {\n",
  "  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {\n",
  "    message('Installing missing package: ', pkg)\n",
  "    install.packages(pkg, repos = 'https://cloud.r-project.org/')\n",
  "    library(pkg, character.only = TRUE)\n",
  "  }\n",
  "}\n",
  "\n",
  "# Load required packages\n",
  "ensure_package('here')\n",
  "ensure_package('tidyverse')\n",
  "ensure_package('knitr')\n",
  "ensure_package('DBI')\n",
  "ensure_package('RSQLite')\n",
  "ensure_package('readr')\n",
  "\n",
  "# ===================================================================\n",
  "# Define Common Paths\n",
  "# ===================================================================\n",
  "\n",
  "OUTPUT_DB <<- here('data', 'projects.db')\n",
  "template_path <<- here('templates', 'project-template.Rmd')\n",
  "\n",
  "# ===================================================================\n",
  "# Source Helper Functions\n",
  "# ===================================================================\n",
  "\n",
  "helper_file <- here('helper-functions', 'helper-functions.R')\n",
  "if (file.exists(helper_file)) {\n",
  "  source(helper_file)\n",
  "  message('‚úì Loaded helper functions')\n",
  "} else {\n",
  "  stop('‚ùå helper-functions.R not found at: ', helper_file)\n",
  "}\n",
  "\n",
  "# ===================================================================\n",
  "# Database Initialization/Validation\n",
  "# ===================================================================\n",
  "\n",
  "if (!file.exists(OUTPUT_DB)) {\n",
  "  message('\\nDatabase not found. Initializing...')\n",
  "  init_database(overwrite = TRUE)\n",
  "} else {\n",
  "  # Check if database needs updating\n",
  "  db_status <- check_database(OUTPUT_DB)\n",
  "  if (db_status$exists) {\n",
  "    message('‚úì Database found: ', db_status$message)\n",
  "    \n",
  "    # Verify critical columns exist\n",
  "    required_cols <- c('project_id', 'source', 'broad_header', 'section', 'include')\n",
  "    missing <- setdiff(required_cols, db_status$columns)\n",
  "    if (length(missing) > 0) {\n",
  "      warning('Database missing required columns: ', paste(missing, collapse=', '))\n",
  "      message('Rebuilding database...')\n",
  "      init_database(overwrite = TRUE)\n",
  "    }\n",
  "  } else {\n",
  "    message('Database exists but appears corrupted. Rebuilding...')\n",
  "    init_database(overwrite = TRUE)\n",
  "  }\n",
  "}\n",
  "\n",
  "# ===================================================================\n",
  "# Load Project Data into Global Environment\n",
  "# ===================================================================\n",
  "\n",
  "if (!exists('projects_df')) {\n",
  "  tryCatch({\n",
  "    con <- dbConnect(RSQLite::SQLite(), OUTPUT_DB)\n",
  "    projects_df <<- dbReadTable(con, 'projects')\n",
  "    dbDisconnect(con)\n",
  "    n_projects <<- nrow(projects_df)\n",
  "    message('‚úì Loaded ', n_projects, ' projects from database')\n",
  "  }, error = function(e) {\n",
  "    stop('Failed to load projects from database: ', e$message)\n",
  "  })\n",
  "}\n",
  "\n",
  "# ===================================================================\n",
  "# Knitr Options\n",
  "# ===================================================================\n",
  "\n",
  "knitr::opts_chunk$set(\n",
  "  echo = FALSE,\n",
  "  warning = FALSE,\n",
  "  message = FALSE,\n",
  "  fig.path = 'figures/generated/'\n",
  ")\n"
)

# Write the file
cat(common_content, file = common_file)

cat("  ‚úì Created/updated _common.R\n")
cat("  NOTE: _common.R is tracked in git for convenience but regenerated on each build\n")
cat("  This allows individual chapters to be knitted without running this script first\n\n")

# ===================================================================
# STEP 3: Initialize/Update Database
# ===================================================================

cat("Step 3: Initializing/updating project database...\n")

tryCatch({
  # Check if database needs rebuilding
  if (exists("check_database")) {
    db_status <- check_database()
    
    if (!db_status$exists) {
      cat("  Database not found, creating new one...\n")
      init_database(overwrite = TRUE)
    } else {
      cat("  ", db_status$message, "\n")
      
      # Check if CSV files are newer than database
      db_path <- here("data", "projects.db")
      csv1_path <- here("report_project_list.csv")
      csv2_path <- here("pssi_form_data.csv")
      
      if (file.exists(db_path) && file.exists(csv1_path) && file.exists(csv2_path)) {
        db_mtime <- file.info(db_path)$mtime
        csv1_mtime <- file.info(csv1_path)$mtime
        csv2_mtime <- file.info(csv2_path)$mtime
        
        if (csv1_mtime > db_mtime || csv2_mtime > db_mtime) {
          cat("  CSV files updated since last build. Rebuilding database...\n")
          init_database(overwrite = TRUE)
        } else {
          cat("  ‚úì Database is up-to-date\n")
        }
      }
    }
  }
}, error = function(e) {
  cat("  ‚ö† Database initialization warning:", conditionMessage(e), "\n")
  cat("  Attempting to continue...\n")
})

cat("\n")

# ===================================================================
# STEP 4: Verify Required Packages for Rendering
# ===================================================================

cat("Step 4: Verifying required packages...\n")

required_packages <- c("quarto", "flextable", "openxlsx")
missing_packages <- character(0)

for (pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    missing_packages <- c(missing_packages, pkg)
  }
}

if (length(missing_packages) > 0) {
  cat("  Installing missing packages:", paste(missing_packages, collapse = ", "), "\n")
  install.packages(missing_packages, repos = "https://cloud.r-project.org/")
}

cat("  ‚úì All required packages available\n\n")

# ===================================================================
# STEP 5: Render Report with Quarto
# ===================================================================

cat("Step 5: Rendering report with Quarto...\n")

library(quarto)

# Change to project directory before rendering (important!)
original_wd <- getwd()
setwd(project_root)

# Ensure we return to original directory even if there's an error
tryCatch({
  
  # Render to Word
  cat("  Rendering to Word from:", getwd(), "\n")
  cat("  This may take several minutes...\n\n")
  
  quarto_render(output_format = "docx")
  
  cat("\n‚úÖ Build Complete!\n\n")
  
  # Find and report the output file
  output_dir <- file.path(project_root, "_book")
  if (dir.exists(output_dir)) {
    docx_files <- list.files(output_dir, pattern = "\\.docx$", full.names = TRUE)
    if (length(docx_files) > 0) {
      cat("üìÑ Output saved to:", docx_files[1], "\n")
      cat("   File size:", format(file.info(docx_files[1])$size / 1024^2, digits = 2), "MB\n\n")
    } else {
      cat("üìÅ Output saved to:", output_dir, "\n\n")
    }
  } else {
    cat("üìÅ Output saved to: _book/\n\n")
  }
  
  # Success summary
  cat("=== Build Summary ===\n")
  cat("‚úì Database initialized/updated\n")
  cat("‚úì _common.R generated\n")
  cat("‚úì Report rendered successfully\n\n")
  cat("Next steps:\n")
  cat("  - Review the output document\n")
  cat("  - Individual chapters can now be knitted for testing\n")
  cat("  - Rerun this script to regenerate after any data changes\n\n")
  
}, error = function(e) {
  cat("\n‚ùå Rendering failed!\n")
  cat("Error:", conditionMessage(e), "\n\n")
  cat("=== Troubleshooting ===\n")
  cat("1. Verify _quarto.yml is in:", project_root, "\n")
  cat("2. Verify index.Rmd exists in:", project_root, "\n")
  cat("3. Check that all chapter files exist and are listed in _quarto.yml\n")
  cat("4. Verify database was created successfully\n")
  cat("5. Check _common.R was created correctly\n")
  cat("6. Try running: source('_common.R') to test for errors\n")
  cat("7. Try running manually in R console: quarto::quarto_render()\n\n")
  
  # Restore working directory even on error
  setwd(original_wd)
  stop("Build failed - see error details above")
  
}, finally = {
  # Always restore working directory
  setwd(original_wd)
})

cat("=== Build script complete ===\n\n")