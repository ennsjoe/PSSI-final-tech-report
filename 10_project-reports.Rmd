---
# Development knitting only - ignored by Quarto book build
output:
  word_document:
    reference_docx: templates/custom-reference.docx
bibliography: bib/references.bib
csl: csl/csas.csl
link-citations: true
---

# Project Reports {#sec:project-reports}

```{r , include=FALSE}
source(here::here("_common.R"))
```

This section provides detailed reports for each PSSI-funded research project. Reports are organized by project ID and include highlights, background, methods, findings, insights, and next steps.

```{r generate-project-reports, results='asis'}

# Verify template exists
if (!file.exists(template_path)) {
  stop("Template not found at: ", template_path, "\n",
       "Make sure templates/project-template.Rmd exists in your project")
}

# Load project data from database
con <- dbConnect(RSQLite::SQLite(), OUTPUT_DB)
projects_df <- dbReadTable(con, "projects")
dbDisconnect(con)

message("Loaded ", nrow(projects_df), " projects from database")

# Convert project_id to character and filter for projects with content
projects_df <- projects_df %>%
  mutate(project_id = as.character(project_id)) %>%
  filter(
    !is.na(project_id),
    !is.na(project_title),
    # Must have at least one content field
    !is.na(highlights) | !is.na(background) | !is.na(methods_findings)
  ) %>%
  arrange(project_id)

message("Generating reports for ", nrow(projects_df), " projects with content")

# Generate a report for each project
for (i in seq_len(nrow(projects_df))) {
  # Extract project as a list for easier access in template
  project <- as.list(projects_df[i, ])
  
  message("Rendering project ", i, "/", nrow(projects_df), ": ", project$project_id)
  
  # Render the project template
  tryCatch({
    cat(knitr::knit_child(
      template_path,
      envir = environment(),
      quiet = TRUE
    ))
    cat("\n\\newpage\n")
  }, error = function(e) {
    # Display error in document
    cat(paste0("\n\n### Project ", project$project_id, ": ", project$project_title, "\n\n"))
    cat(paste0("**Error rendering project:** ", conditionMessage(e), "\n\n"))
    cat("\n\\newpage\n")
    message("ERROR: ", conditionMessage(e))
  })
}

message("Completed rendering ", nrow(projects_df), " project reports")
```
