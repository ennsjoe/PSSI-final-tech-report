---
# Development knitting only - ignored by Quarto book build
output:
  word_document:
    reference_docx: templates/custom-reference.docx
bibliography: bib/references.bib
csl: csl/csas.csl
link-citations: true
---

# Project Reports {#sec:project-reports}

```{r setup, include=FALSE}
source(here::here("_common.R"))
```

This section provides detailed reports for each PSSI-funded research project. Reports are organized by project ID and include highlights, background, methods, findings, insights, and next steps.

```{r generate-project-reports, results='asis'}

# Verify template exists
if (!file.exists(template_path)) {
  stop("Template not found at: ", template_path, "\n",
       "Make sure templates/project-template.Rmd exists in your project")
}

# Load project data from database
con <- dbConnect(RSQLite::SQLite(), OUTPUT_DB)
projects_df <- dbReadTable(con, "projects")
dbDisconnect(con)

message("\n=== Project Data Loaded ===")
message("Total projects in database: ", nrow(projects_df))

# Filter for DFO Science projects with include='y'
projects_to_render <- projects_df %>%
  mutate(project_id = as.character(project_id)) %>%
  filter(
    source == "DFO Science",
    include %in% c("y", "Y"),
    !is.na(project_id),
    !is.na(project_title)
  ) %>%
  arrange(project_id)

# Diagnostics
projects_with_content <- projects_to_render %>%
  filter(!is.na(highlights) | !is.na(background) | !is.na(methods_findings))

projects_without_content <- projects_to_render %>%
  filter(is.na(highlights) & is.na(background) & is.na(methods_findings))

message("\n=== Rendering Plan ===")
message("DFO Science projects with include='y': ", nrow(projects_to_render))
message("  └─ With extracted content: ", nrow(projects_with_content))
message("  └─ Metadata only (no content): ", nrow(projects_without_content))

if (nrow(projects_to_render) == 0) {

  cat("\n\n**No DFO Science projects found marked for inclusion.**\n\n")
  cat("Please check that:\n")
  cat("- Projects have source='DFO Science'\n")
  cat("- Projects have include='y' or include='Y'\n\n")

} else {

  cat("\n\n")

  successful_renders <- 0
  failed_renders <- 0

  for (i in seq_len(nrow(projects_to_render))) {

    project <- as.list(projects_to_render[i, ])

    has_content <- !is.na(project$highlights) ||
                   !is.na(project$background) ||
                   !is.na(project$methods_findings)

    content_status <- if (has_content) "[Full Content]" else "[Metadata Only]"

    message("\n--- Rendering ", i, "/", nrow(projects_to_render), ": ",
            project$project_id, " ", content_status, " ---")

    tryCatch({

      result <- knitr::knit_child(
        template_path,
        envir = environment(),
        quiet = TRUE
      )

      cat(result)

      # TRUE Word page break using OpenXML
      cat("\n\n```{=openxml}\n<w:p><w:r><w:br w:type=\"page\"/></w:r></w:p>\n```\n\n")

      successful_renders <- successful_renders + 1
      message("    ✓ Success")

    }, error = function(e) {

      cat(paste0("\n\n### Project ", project$project_id, ": ", project$project_title, "\n\n"))
      cat("**Error rendering this project report.**\n\n")
      cat("Error: ", conditionMessage(e), "\n\n")

      # Page break after error too
      cat("\n\n```{=openxml}\n<w:p><w:r><w:br w:type=\"page\"/></w:r></w:p>\n```\n\n")

      failed_renders <- failed_renders + 1
      message("    ✗ ERROR: ", conditionMessage(e))
    })

  } # end for loop

  message("\n=== Report Generation Complete ===")
  message("Successfully rendered: ", successful_renders, " projects")
  if (failed_renders > 0) {
    message("Failed to render: ", failed_renders, " projects")
  }

} # end if/else
```