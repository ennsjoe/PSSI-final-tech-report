# Project Reports {#sec:project-reports}

```{r setup, include=FALSE}
source(here::here("_common.R"))
```

This section provides detailed reports for each PSSI-funded research project. Reports are organized by project ID and include highlights, background, methods, findings, insights, and next steps.

```{r generate-project-reports, results='asis'}

# Load project data from standard locations
projects_df <- NULL

# 1. Try Database (standard location: data/projects.db)
if (file.exists(OUTPUT_DB)) {
  tryCatch({
    con <- dbConnect(RSQLite::SQLite(), OUTPUT_DB)
    if ("projects" %in% dbListTables(con)) {
      projects_df <- dbReadTable(con, "projects")
    }
    dbDisconnect(con)
  }, error = function(e) {
    message("Could not load from database: ", e$message)
  })
}

# 2. Try CSV Fallback (if DB failed or is empty)
if (is.null(projects_df) || nrow(projects_df) == 0) {
  # Check multiple possible paths for the flat data structure
  csv_paths <- c(
    OUTPUT_CSV, 
    here::here("data", "pssi_form_data.csv"),
    here::here("pssi_form_data.csv")
  )
  
  for (csv_path in csv_paths) {
    if (file.exists(csv_path)) {
      tryCatch({
        projects_df <- readr::read_csv(csv_path, show_col_types = FALSE)
        if (nrow(projects_df) > 0) break
      }, error = function(e) next)
    }
  }
}

# 3. Data Integrity & Synonyms (Fix for the 'project_number' error)
if (!is.null(projects_df) && nrow(projects_df) > 0) {
  
  # Standardize column names: Rename 'project_number' to 'project_id' if necessary
  if ("project_number" %in% names(projects_df) && !("project_id" %in% names(projects_df))) {
    projects_df <- projects_df %>% rename(project_id = project_number)
  }
  
  # Filter out rows with no ID or Title
  projects_df <- projects_df %>% 
    filter(!is.na(project_id), !is.na(project_title)) %>%
    mutate(project_id = as.character(project_id))
  
  # Sort by Project ID
  projects_df <- projects_df %>% arrange(project_id)
}

# 4. Final Validation Check
if (is.null(projects_df) || nrow(projects_df) == 0) {
  stop("Could not load project data. Please ensure data/pssi_form_data.csv exists.")
}

required_fields <- c('project_id', 'project_title')
missing_fields <- setdiff(required_fields, names(projects_df))
if (length(missing_fields) > 0) {
  stop("Missing required fields: ", paste(missing_fields, collapse = ", "),
       "\nAvailable fields: ", paste(names(projects_df), collapse = ", "))
}

# 5. Generate a report section for each project using the template
for (i in seq_len(nrow(projects_df))) {
  project <- projects_df[i, ]
  
  # Render the project template
  tryCatch({
    cat(knitr::knit_child(
      template_path,
      envir = environment(),
      quiet = TRUE
    ))
    cat("\n\\newpage\n") # Force page break between projects
  }, error = function(e) {
    cat(paste0("\n\n::: {.alert .alert-warning}\n",
               "**Error rendering Project ", project$project_id, ":** ", 
               conditionMessage(e), "\n:::\n\n"))
  })
}
```
