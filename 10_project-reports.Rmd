---
output:
  word_document:
    reference_docx: templates/custom-reference.docx
bibliography: bib/references.bib
csl: csl/csas.csl
link-citations: true
---

# Project Reports {#project-reports}

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
source(here::here("_common.R"))
```

```{r generate-project-reports, results='asis', echo=FALSE, message=FALSE, warning=FALSE}

if (!file.exists(template_path)) {
  stop("Project template not found at: ", template_path)
}

# ------------------------------------------------------------------
# Identify form-data projects directly from projects_df.
#
# init_database() builds the DB from two sets:
#   Set A -- rows from pssi_form_data.csv joined with tracking metadata
#   Set B -- fallback rows built purely from the tracking sheet
#
# Set B never touches form-only columns (highlights, project_leads,
# collaborations, region, species, waterbodies, life_history, stock,
# population, cu, references, tables_figures). After bind_rows() those
# columns are NA for every Set B row. Any project with at least one of
# those columns non-NA must have come from the form.
# ------------------------------------------------------------------

form_only_cols <- intersect(
  c("highlights", "project_leads", "collaborations", "region", "species",
    "waterbodies", "life_history", "stock", "population", "cu",
    "references", "tables_figures"),
  names(projects_df)
)

message("Form-only columns present in projects_df: ",
        paste(form_only_cols, collapse = ", "))

projects_to_render <- projects_df %>%
  dplyr::mutate(
    project_id   = as.character(project_id),
    broad_header = tidyr::replace_na(as.character(broad_header), "Other"),
    section      = tidyr::replace_na(as.character(section),      "Other")
  ) %>%
  dplyr::filter(
    source  == "DFO Science",
    include %in% c("y", "Y"),
    !is.na(project_id),
    !is.na(project_title),
    # Keep only rows where at least one form-only column is populated;
    # pure tracking-sheet (Set B) rows have NA for all of these.
    dplyr::if_any(dplyr::all_of(form_only_cols), ~ !is.na(.))
  ) %>%
  dplyr::arrange(broad_header, section, project_id)

message("\n", rep("=", 80))
message("RENDERING PROJECT REPORTS")
message(rep("=", 80), "\n")
message("Total rows in projects_df : ", nrow(projects_df))
message("Form-data projects found  : ", nrow(projects_to_render))
message("")

successful_renders   <- 0
failed_renders       <- 0
current_broad_header <- NULL
current_section      <- NULL
first_group          <- TRUE

for (i in seq_len(nrow(projects_to_render))) {
  project <- projects_to_render[i, ]

  # -- Broad header heading --------------------------------------------
  if (is.null(current_broad_header) ||
      !identical(project$broad_header, current_broad_header)) {
    current_broad_header <- project$broad_header
    current_section      <- NULL

    if (!first_group) cat("\n\n\\newpage\n\n")
    first_group <- FALSE

    cat("## ", current_broad_header, "\n\n", sep = "")
  }

  # -- Section heading -------------------------------------------------
  if (is.null(current_section) ||
      !identical(project$section, current_section)) {
    current_section <- project$section
    cat("### ", current_section, "\n\n", sep = "")
  }

  # -- Project page ----------------------------------------------------
  message("  Rendering ", i, "/", nrow(projects_to_render),
          " [", project$section, "]: ", project$project_id)

  tryCatch({
    cat(knitr::knit_child(template_path, envir = environment(), quiet = TRUE))
    cat("\n\n\\newpage\n\n")
    successful_renders <- successful_renders + 1
    message("    \u2713 Success")
  }, error = function(e) {
    cat("\n\n#### Project ", project$project_id, "\n\n", sep = "")
    cat("**Error:** ", e$message, "\n\n", sep = "")
    cat("\n\n\\newpage\n\n")
    failed_renders <<- failed_renders + 1
    message("    \u2717 ERROR: ", e$message)
  })
}

message("\n", rep("=", 80))
message("Successfully rendered: ", successful_renders, " projects")
if (failed_renders > 0) message("Failed: ", failed_renders, " projects")
message(rep("=", 80))
```
