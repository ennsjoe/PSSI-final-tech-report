---
# Development knitting only - ignored by Quarto book build
output:
  word_document:
    reference_docx: templates/custom-reference.docx
bibliography: bib/references.bib
csl: csl/csas.csl
link-citations: true
---

# Project Reports {#sec:project-reports}

```{r setup, include=FALSE}
source(here::here("_common.R"))
```

This section provides detailed reports for each PSSI-funded research project. Reports are organized by project ID and include highlights, background, methods, findings, insights, and next steps.

```{r generate-project-reports, results='asis'}

# Verify template exists
if (!file.exists(template_path)) {
  stop("Template not found at: ", template_path, "\n",
       "Make sure templates/project-template.Rmd exists in your project")
}

# Load project data from database
con <- dbConnect(RSQLite::SQLite(), OUTPUT_DB)
projects_df <- dbReadTable(con, "projects")
dbDisconnect(con)

# Filter for DFO Science projects only
projects_df <- projects_df %>%
  mutate(project_id = as.character(project_id)) %>%
  filter(
    !is.na(project_id),
    !is.na(project_title),
    source == "DFO Science"  # Only show DFO Science projects
  ) %>%
  arrange(project_id)

message("Generating reports for ", nrow(projects_df), " DFO Science projects")

# Generate a report section for each project using the template
for (i in seq_len(nrow(projects_df))) {
  project <- projects_df[i, ]
  
  # Render the project template
  tryCatch({
    cat(knitr::knit_child(
      template_path,
      envir = environment(),
      quiet = TRUE
    ))
    # Page break (pandoc converts for Word output)
    cat("\n\n\\newpage\n\n")
  }, error = function(e) {
    cat(paste0("\n\n## Project ", project$project_id, "\n\n"))
    cat(paste0("*Error generating report: ", e$message, "*\n\n"))
    cat(paste0("*Template path: ", template_path, "*\n\n"))
    cat("\n\n\\newpage\n\n")
  })
}
```
