# Auto-generated by build-report.R
# This file is sourced by all chapter files

library(here)
library(tidyverse)
library(knitr)
library(DBI)
library(RSQLite)
library(readr)

# Define common paths
OUTPUT_DB <<- here('data', 'projects.db')
OUTPUT_CSV <<- here('data', 'processed', 'pssi_form_data.csv')
INPUT_DIR <<- here('data', 'word_docs')
template_path <<- here('templates', 'project-template.Rmd')

# Source helper functions if not already loaded
if (!exists('get_db_connection')) {
  helper_file <- here('helper-functions', 'helper-functions.R')
  if (file.exists(helper_file)) {
    source(helper_file)
  }
}

# Load project data if not already loaded
if (!exists('projects_df')) {
  # Try multiple possible CSV locations
  csv_paths <- c(
    here('data', 'processed', 'pssi_form_data.csv'),
    here('data', 'raw', 'report_project_list.csv')
  )
  
  csv_loaded <- FALSE
  for (csv_path in csv_paths) {
    if (file.exists(csv_path)) {
      projects_df <<- read_csv(csv_path, show_col_types = FALSE)
      
      # Filter based on which columns exist
      if ('project_id' %in% names(projects_df)) {
        projects_df <<- projects_df %>% filter(!is.na(project_id))
      } else if ('project_number' %in% names(projects_df)) {
        projects_df <<- projects_df %>% filter(!is.na(project_number))
      }
      
      n_projects <<- nrow(projects_df)
      message('Loaded ', n_projects, ' projects from: ', csv_path)
      csv_loaded <- TRUE
      break
    }
  }
  
  if (!csv_loaded) {
    warning('No project CSV found in expected locations')
    projects_df <<- data.frame()
    n_projects <<- 0
  }
}
